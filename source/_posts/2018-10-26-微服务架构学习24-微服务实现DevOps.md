---
title: 微服务架构学习24-微服务实现DevOps
tags: [微服务]
---
# 微服务架构学习24-微服务实现DevOps
单体应用拆分成多个微服务之后，每个服务都可以独立进行开发、测试和运维，工作量比之前提升很多。这时候就迫切需要一种新的开发、测试和运维模式来解决问题，这就涉及到了微服务与DevOps。  

## DevOps
传统模式下，开发人员、测试人员和运维人员职责划分十分明确，分属于不同的职能部门，一次业务上线需要三者之间进行多次沟通，整个周期以天为单位。DevOps是一种新型的业务研发流程，业务的开发人员不仅需要负责业务代码的开发，还需要负责业务的测试以及上线发布等全生命周期，真正做到掌控服务全流程。    

而要实现DevOps，就必须开发完成代码之后，能够进行自动测试、测试通过后，自动发布到线上。对应的两个过程就是CI和CD。
- CI（Continous Integration），持续集成。开发完成代码之后，能够自动进行代码检查，单元测试、打包部署到测试环境，进行集成测试，跑自动化测试用例。   
- CD（Continous Deploy），持续部署。代码测试通过后，能自动部署到类生产环境进行集中测试，测试通过后再进行小流量的灰度验证，验证通过后可以把代码自动部署到线上。   
CD 还有另一个解释就是持续交付（Continous Delivery），与持续部署不同的是，持续交付只需要做到代码达到线上发布要求的阶段就可以，接下来代码部署到线上既可以选择手动部署也可以选择自动部署。因为实际情况下，需要人为判断整个发布过程是否正常。   

## 微博的DevOps实践
目前业界比较通用的实现DevOps主要有两种，一种是使用Jenkins另一种使用GitLab，微博主要使用GitLab。
![devops](/images/wbwfwsj24_devops.png)<br/>

由上图可知，一个服务的发布流程主要包含三个步骤：

1. 持续集成。该步骤主要是确保每一次代码的Merge Request都测试通过，可随时合并到代码的DEV分支，主要包括：build阶段（开发分支代码的编译与单元测试）、package阶段（开发分支代码打包成Docker镜像）、deploy阶段（开发分支代码部署到测试环境）、test阶段（开发分支代码集成测试）。
2. 持续交付，步骤的主要作用是确保所有的代码合并到dev分支后，dev的分支代码能够在生产环境测试通过，并通过灰度验证，随时交付线上。主要包含五个阶段：build（Dev分支的代码编译和单元测试）、package阶段（dev分支的代码打包成docker镜像）、deploy阶段（dev分支的代码部署到测试环境）、test阶段（dev分支的代码集成测试）、canary阶段（dev分支的代码小流量灰度验证）
3. 持续部署，该步骤的主要作用是合并dev分支到master，并打包成docker镜像，可随时发布到线上。主要包括四个阶段：build（master主干的代码编译与单元测试）、package阶段（master主干的代码打包成docker镜像）、clear阶段（master主干的代码merge回dev分支）、prod阶段（master代码发布到线上）   
在gitlab中可以通过一个叫`gitlab-ci.yml`的文件来定义自动化流程包含哪些阶段，以及每个阶段执行的脚本。

## 实现DevOps的关键点
### 持续集成阶段
持续集成阶段主要目的是保证每一次开发的代码都没有问题，即使合并到主干也能正常工作，主要依靠以下下个部分：
- 代码检查：通过代码检查可以发现一些潜在的bug，可以集成类似[sonarqube](https://www.sonarqube.org/)来实现代码检查。
- 单元测试。针对每个具体的代码模块机械能测试。
- 集成测试就是将各个代码的修改集成到一起，统一部署在测试环境进行测试。为了实现整个流程的自动化，集成自测阶段的主要任务就是跑每个服务的自动化测试用例，所以自动化测试用例覆盖越全，集成测试可靠性就越高。  
集成测试业务代码部署的测试机器可使用docker技术，以避免测试机器的不足。

### 持续交付阶段
持续交付阶段的目的是保证最新的业务代码，能够在类生产环境中正常运行，一般做法是通过在线上生产环境摘掉两个节点，然后在这两个节点上部署最新的业务代码，再进行集成测试。集成测试通过后再引入线上流量，来观察服务是否正常。通常需要解决两个问题：
- 如何从生产环境摘除两个节点，需要接入线上的容器管理平台。 
- 如何观察服务是否正常，一个是观察节点本身的状态，如CPU、内存等，一个是观察业务运行产生的warn、error的日志量的大小，尤其error量有异常时，说明最新的代码可能存在异常。


### 持续部署阶段
持续部署并不要求那么完美，许多公司在这个阶段都采用手动发布的方式以控制风险，或者只做到持续交付阶段，对于持续部署并不要求自动化。




















































 





























































