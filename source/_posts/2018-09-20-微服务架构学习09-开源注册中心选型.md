---
title: 微服务架构学习09-开源注册中心选型
tags: [微服务]
---
# 微服务架构学习09-开源注册中心选型
当下主流的服务注册与发现的解决方案，主要有两种：
- 应用内注册与发现：注册中心提供服务端和客户端的SDK，业务应用通过引入注册中心提供的SDK，通过SDK与注册中心交互，来实现服务的注册和发现。
- 应用外注册与发现：业务应用本身不需要通过SDK与注册中心打交道，而是通过其他方式与注册中心交互，间接完成服务注册与发现。

## 应用内注册与发现的注册中心
典型案例是Netflix开源的Eureka，架构图如下：
![微服务服务注册中心eureka架构图](/images/wbwfwsj09_eureka.png)<br/>
上图中Eureka架构图有三个重要组成部分：
- Eureka Server：注册中心的服务端，实现了服务信息注册，存储一级查询等功能。
- 服务端的Eureka Client：集成在服务端的注册中心SDK，服务提供者通过调用SDK，实现服务的注册与反注册等功能。
- 客户端的Eureka Clinet：集成在客户端的注册中心SDK，服务消费者通过调用SDK，实现服务订阅、服务更新等功能。

## 应用外注册与发现的注册中心
应用外实现服务注册和发现，最典型案例是开源注册中心Consul，架构图如下：
![微服务服务注册中心eureka架构图](/images/wbwfwsj09_consul.png)<br/>
架构图中采用Consul实现应用外服务注册和发现主要依靠三个重要的组件：
- Consul：注册中心的服务端，实现服务注册信息的存储，并提供注册和发现服务。
- Registrator：一个开源的第三方服务管理器项目，通过监听服务部署的Docker实例是否存活，来负责服务提供者的注册和销毁。
- Consul Template： 定时从注册中心服务端获取最新的服务提供者节点列表并刷新LB配置（比如Nginx的upstream），这样服务消费者就能通过访问nginx获取最新的服务提供者信息。

两者兼得区别，应用内的解决方案适用于服务提供者和消费者同属于一个技术体系，应用外的解决方案一般适合服务提供者和服务消费者采用了不同的技术体系。对于容器化的云应用来说，一般不适合采用应用内SDK解决方案，会侵入业务，应用外的解决方案会解决这个问题。 

## 注册中心选型考虑的问题
两个最值得关注的问题，一个是高可用性，一个是数据一致性。
### 高可用性
实现高可用性的方法主要有两种：
- 集群部署，通过部署多个实例组成集群来保证高可用性
- 多IDC部署，部署不止一个机房。
![微服务服务注册中心eureka架构图](/images/wnwfwsj09_consul02.png)<br/>
由上图可知采用了多数据中心，每个数据中心采用了多服务器的部署方式。 

### 数据一致性
同时满足CAP理论是不可行的。C代表一致性，A代表可用性，P代表分区容错性。  根据满足CAP的问题，注册中心可以分成三类。
- CP型注册中心，牺牲可用性来保证数据强一致性，最典型例子ZOO keeper。zoo keeper只有一个leader，这个leader负责写入，并会同步信息到Followers，这个过程保证强一致性，如果多个网络之间网络存在问题，出现多个leader，注册中心就不可用了。 
- AP型，典型例子Eureka，牺牲掉强一致性。它不用选举leader，每个Eureka服务器单独报错服务器注册地址，因此可能存在数据信息不一致的情况。但是当网络存在问题的时候，每台服务器都可以完成独立的服务。
- CA型，典型例子Consul。Consul采用Gossip协议保证最终一致性，解决方案：在一个有界网络中，每个节点随机与其余节点通信，经过一番杂乱无章的通信，最终所有节点的状态都会达成一致，从而保证在最终所有节点一致。 


对于数据中心来说，最主要的功能是服务的注册和发现。在网络出现问题的时候，可用性的需求远远高于数据一致性。选择AP型或者CA型注册中心更合适。


## 总结
- 如果业务体系都是采用JAVA，Eureka是一个不错的选择。作为服务注册与发现方案能够最大程度的保证可用性。即使节点之间出现数据不一致，仍然能够访问Eureka。
- 如果业务体系语言比较复杂，Eureka也提供了Sidecar解决方案。也可以考虑使用Consul，它支持多种语言接入。
- 如果业务已经是云原生的应用，可以考虑使用Consul，搭配Registrator 和 Consul Template 实现应用外的服务注册和发现。



## 参考
[极客时间-微服务架构学习](https://time.geekbang.org/column/article/39797)











