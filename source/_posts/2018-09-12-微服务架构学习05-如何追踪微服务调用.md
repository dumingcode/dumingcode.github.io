---
title: 微服务架构学习05-如何追踪微服务调用
tags: [微服务]
---
# 微服务架构学习05-如何追踪微服务调用
本系列文章为极客时间课程《从0开始学微服务》课程记录。 微服务架构下，由于进行了服务拆分，每个服务可能由不同的团队开发，使用了不同的编程语言，可能部署在不同的机器上，分布在不同的数据中心。下图为用户访问微博首页，一次请求所涉及的服务。 
![微服务调用示例图](/images/wbwfwsj05_wbdy.png)<br/>

服务追踪系统，可以跟踪用户请求都进行了哪些调用，经过哪些服务处理，并且记录每一次调用所涉及的服务的详细信息，这时候如果发生调用失败，就可以通过这个日志快速定位是哪个环节出了问题。  

## 服务追踪作用
### 优化系统瓶颈
通过记录调用经过的每一条链路上的耗时，快速定位整个系统的瓶颈点。
### 优化链路调用
通过服务追踪可以分析调用经过的路径是否合理。比如一个服务调用调用下游多个服务，通过调用链分析，可以评估是否每个依赖是否必要，是否可以通过业务优化来减少服务依赖。
通过对链路进行分析，可以找出跨数据中心的调用，从而进行优化，尽量避免此种情况发生。 

### 生成网络拓扑
通过链路信息，可以生成一张系统的网络调用拓扑图。可以反映系统都依赖哪些服务，以及服务之间的调用关系是什么样的。

### 透明传输数据
业务经常有需求，想把一些用户数据，从调用的开始一直往下传递，以便各个系统都能获取这个信息。 

## 服务追踪系统原理
首先推荐一篇论文
[Dapper，大规模分布式系统的跟踪系统](http://bigbully.github.io/Dapper-translation/)。核心理念就是调用链，通过一个全局唯一的ID将分布在各个服务节点上的同一次请求串联起来，从而还原原有的调用关系，可以追踪系统问题、分析调用并统计各种系统指标。 
比较有名的服务追踪系统，Zipkin，[阿里的鹰眼](Dapper，大规模分布式系统的跟踪系统)、[美团的MTrace](Dapper，大规模分布式系统的跟踪系统)。
### 服务追踪基本概念
traceid，spanid，annonation。   
![微服务追踪系统基本概念](/images/wbwfwsj05_jbgn.png)<br/>

#### traceId
用于标识某一次具体的请求id。当用户的请求进入系统后，会在RPC调用网络的第一层生成一个全局唯一的traceId，并且会随着每一层RPC的调用，不断往后传递，这样的话traceID就可以把一次用户请求在系统中调用的路径串联起来。 

#### spanId
标识一次RPC调用在分布式请求中的位置。当用户请求进入系统后，处在RPC调用网络的第一层A时spanid为0，进入下一层RPC调用B的时候spanid为0.1，继续进入下一层C时spanid是0.1.1，而与B同一层RPC调用E的spanid是0.2，这样的话通过spanid就可以定位某一次RPC请求在系统调用中所处的位置，以及它的上下游依赖分别是谁。  

#### annotation
用于业务自定义埋点。可以是业务感兴趣的想传到后端的数据，比如一次请求的用户UID。


## 服务追踪系统实现
![微服务追踪系统设计图](/images/wbwfwsj05_zzxtsj.png)<br/>
由上图可知，数据分三层，数据采集层、数据处理层、数据展示层。
### 数据采集层
在系统的各个不同的模块中进行埋点，采集数据并上传给数据处理层进行处理。埋点示意图如下：
![微服务数据埋点](/images/wbsfwsj05_sjmd.png)<br/>
图中红色方框中的调用过程如下：
- CS（Client Send）阶段 : 客户端发起请求，并生成调用上下文。
- SR（Server Recieve）阶段 :服务端接收请求，并生成上下文。
- SS（Server Send）阶段 : 服务端返回请求，并将服务端上下文数据上报。
- CR（Client Receive）阶段：客户端接收返回数据，并将客户端上下文数据上报。

![微服务数据埋点交互图](/images/wbwfwsj05_mdjh.png)<br/>

### 数据处理层
将数据采集层上报的数据按需计算，然后落地存储供查询使用。数据处理的需求一般分为两类，一类是实时需求，一类是离线计算需求。
#### 实时数据处理
一般采用Storm或者Spark Streaming 对链路数据进行实时聚合加工，存储一般采用OLTP数据仓库，比如HBase。使用traceid作为Rowkey，能够把一条调用链聚合在一起，提高查询效率
#### 离线数据处理
一般通过运行Map reduce或者Spark 批处理程序来对链路数据进行离线计算，存储一般采用Hive。 

### 数据展示层
将处理后的链路信息以图形化的方式展示给用户，常用的一般是调用链路图，一种是调用拓扑图。
#### 调用链路图
![微服务数据调用链路图](/images/wbwfwsj05_dyllt.png)<br/>
主要被用来故障定位。 

#### 调用拓扑图
通过这张图可以看出系统内包含哪些应用，他们之间是什么关系，一级以来调用的QPS、平均耗时情况。

![微服务数据调用拓扑路图](/images/wbwfwsj05_dytpt.png)<br/>

用作全局监控，发现系统中的异常点，从而快速做出决策。比如一个服务出现异常，造成调用链路拓扑图中可以看出对这个服务的调用耗时都变高了，可以用红色的图样标出来，用作监控报警。














































































































































