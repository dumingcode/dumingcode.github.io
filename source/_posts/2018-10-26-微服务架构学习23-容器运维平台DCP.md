---
title: 微服务架构学习23-容器运维平台DCP
tags: [微服务]
---
# 微服务架构学习23-容器运维平台DCP

## DCP 整体架构
主要分成四个部分：基础设施层、主机层、调度层、编排层。
- 基础设施层：解决镜像仓库的问题。
- 主机层：解决如何进行资源调度的问题。 
- 调度层：解决容器如何在资源上创建的问题。
- 编排层：解决容器如何运作以及对外提供服务的问题。 
![dcp](/images/wbwfwsj_dcp.png)<br/>


### 基础设置层
DCP基础设施层主要用于提供各种基础设施。主要包括：（1）用于存放容器镜像的镜像仓库（2）提供监控服务的监控中心（3）实时监控系统容量以便自动扩缩容的容量评估系统（4）容器创建后如何加入线上服务的服务发现组件。镜像仓库是DCP核心的基础组件。 
![dcp基础层](/images/wbwfwsj23_alharbor.png)<br/>

### 主机层
主要为了完成资源的调度，针对不同的集群、完成主机的创建、成本的管理以及配置初始化工作，也叫做Pluto层。

#### 主机创建
![dcp-plauto](/images/wbwfwsj23_plauto.png)<br/>
阿里云自动创建的示意图如下：
![dcp-阿里云自动创建](/images/wbwfwsj23_aliyun.png)<br/>

阿里云除了有单账户调用的并发限制，还会有可用区的库存限制，安全组库存限制以及vSwitchk库存限制，所以在使用阿里云API创建ECS时，当机器规模较大，如果直接指定某个可用区、安全组和vSwitch时，可能因为库存原因导致创建失败。   

解决方案是针对可用区、安全组以及vSwwitch都做了多可用区、多安全组以及多Switch配置，在出现库存不够时，就自动切换到别的地方来创建，极大提高了大规模ECS创建的成功率。 
![dcp-阿里云API自动创建](/images/wbwfwsj23-alycj.png)<br/>

#### 成本管理
无论是从共享池内创建的机器，还是调用阿里云API创建的ECS，都是有成本的，必须对机器的数量以及使用时长进行记录，以便进行成本管理。阿里云有如下的计费策略：
- 按量付费
- 按月付费
- 按年付费

#### 配置初始化
主机创建完成后，需要进行一些基础软件的安装以及配置修改等工作，这就是配置初始化的过程。如果短时间内创建上千台ECS，这时候配置工作量就会非常大。DCP进行主机配置化时，会通过Ansible向所有主机下发配置文件和基础软件，并通过自定义callback queue，把每台主机的初始化状态异步写入到DB中，避免上百台机器同时并发写入DB造成死锁。
![dcp-初始化主机](/images/wbwfwsj23_csh.png)<br/>

### 调度层
DCP中调度层的主要功能是在可用的主机上创建容器，选择Swarm作为容器调度的工具，并在Swarm基础上进行二次封装，定制了自己的调度层Roam，使其具备跨IDC、高可用以及可扩展的特性。下面是Roam的架构图：
![dcp-roam](/images/wbwfwsj23_roam.png)<br/>


### 编排层
DCP编排层的主要作用是对服务进行整合以对外提供服务，主要包括服务依赖、服务发现以及自动扩缩容。

#### 服务依赖
DCP通过模板来管理容器的创建，一个服务如果需要进行扩容、创建容器，必须按照模板里的定义的参数来执行。模板定义的参数主要包括：任务的名称、机器的配置、任务依赖、任务详细配置（包括调用阿里云 API创建ECS时的可用区、安全组参数等），其中任务依赖配置项：
```
{"Sid":1707061842070000,"Ratio":0.2,"ElasticCount":0}
{"Sid":1703271821000000,"Ratio":0.3,"ElasticCount":0}

```
它的含义是执行这个扩容任务时，会自动执行ID为`1707061842070000`和`1703271821000000`的扩容任务，并按照没扩容10台容器分别扩容2台和3台依赖容器的比例来执行。
![dcp-容器创建模板](/images/wbwfwsj23_mb.png)<br/>

#### 服务发现

微博的业务场景包含两种服务，一种是HTTP服务，一种是Motan RPC服务，分别使用不同的服务发现方式。
- HTTP服务。考虑到基于Nginx配置reload机制实现的服务发现方式，在高并发访问的情况下，导致吞吐量下降10%，为此DCP在实际业务中基于Nginx和Consul开发了解决方案[nginx-upsync-module](https://github.com/weibocom/nginx-upsync-module)。
- Motan RPC服务。Motan RPC服务启动时，会向注册中心Config Service注册服务，并且注册中心支持多IDC部署。

![dcp-motan服务发现](/images/wbwfwsj23_motan.png)<br/>

#### 自动扩缩容
DCP 实现自动扩缩容主要依赖容量决策支持系统，由容量决策支持系统来实时监控系统的容量。一旦决策支持系统检测到某个服务需要扩容，会自动创建扩容任务，Config Watcher会监控到扩容任务，并通知CronTrigger有调度策略变更。CronTrigger 接到扩容任务，会调用Schedule来具体执行扩容。
![dcp-自动扩缩容](/images/wbwfwsj23_ksr.png)<br/>

## 总结
![dcp-总结](/images/wbwfwsj23_zj.png)<br/>

















































 





























































