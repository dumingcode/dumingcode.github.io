---
title: 微服务架构学习27-微服务混合云部署实践
tags: [微服务]
---
# 微服务架构学习27-微服务混合云部署实践
混合云部署，既在企业内部的私有云部署服务，又使用企业外部公有云部署服务的模式。面临的问题：

- 跨云服务实现负债均衡
- 跨云服务实现数据同步
- 跨云服务实现容器运维

## 跨云服务的负载均衡
私有云机房部署了VIP和Nginx分别作为四层和七层的负债均衡，阿里云机房部署了SLB和Nginx分别用作四层和七层负载均衡。
![公有云私有云架构部署](/images/wbwfwsj27_gyy.png)<br/>

## 跨云服务的数据同步
公有云部署和内部私有云部署服务一些不同点：
- 私有云与公有云之间的网络隔离，为了实现互通需要假设VPN网络或者专线。 
![专线](/images/wbwfwsj27_gyy2.png)<br/>
- 数据库能否上云，企业的核心业务数据，往往会出于安全隐私考虑，并不敢直接放到云上部署。  
![中间件部署](/images/wbwfwsj_gyy3.png)<br/>
阿里云的机房主要用于承担下行的读请求，部署的缓存也不是跟内网机房完全一致，而是只部署了最核心的服务所依赖的缓存，这样可以把大部分阿里云机房的请求都在内部消化，减少到内网数据库的穿透，从而节省跨云专线的带宽使用。
![中间件部署](/images/wbwfwsj27_gyy4.png)<br/>

## 跨云服务的容器运维
要求有一套统一的容器运维平台能同时对接内部私有云和外部公有云。

### 跨云的主机管理
跨云主机管理的关键点在于，如何对内部私有云的机器和公有云的ECS进行管理，在DCP里按照“主机-服务池-集群”的模式进行管理。   
- 主机：某一台具体的服务器，可能是私有云创建的虚拟机，也有可能是公有云创建的ECS。
- 服务池：针对某个具体的服务，由这个服务部署的主机组成，可能同时包含私有云和公有云，规模可能是几台或者上百台。
- 集群，针对某个具体的业务线而言，可能包含有多个服务池。  

### 跨云服务发现
DCP的服务发现主要有两种方式：一种是针对HTTP服务采用的nginx-upsync-module，一种是RPC服务的Config Service。除此之外，阿里云上部署的服务还可以直接使用SLB（负载均衡）来做服务发现。
![跨云服务发现](/images/wbwfwsj27_hbf.png)<br/>

### 跨云弹性扩容
流量上涨，超出内部私有云机房部署所能承受的范围时，需要扩容阿里云机房的机器，然后把流量切换到阿里云机房。有两种方案，一是在DNS层切换，把原先解析到私有云机房VIP的流量，解析到阿里云机房的SLB，这时候阿里云机房部署的SLB、Nginx、JAVA WEB 都需要扩容。另一种是在Nginx 层切换，把原先转发到私有云机房的Nginx流量，转发到阿里云机房的JAVA WEB，这时候只需要扩容阿里云的JAVA web。  
![跨云服务发现](/images/wbwfwsj27_llzh.png)<br/>

### 跨云服务编排
在进行服务编排时，如果服务跨云部署，要考虑跨机房访问的问题。下图FEED服务依赖user 和 card服务，如果feed扩容的话，需要先扩容user和card。
![服务编排](/images/wbwfwsj27_fwbp.png)<br/>


## 总结
微服务混合云部署必须解决三个问题：跨云服务的负载均衡、跨云服务的数据同步、跨云服务的容器运维。










































