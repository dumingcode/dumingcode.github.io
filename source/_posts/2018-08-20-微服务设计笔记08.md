---
title: 微服务设计笔记08
tags: [微服务]
---
# 微服务设计笔记08
本篇笔记为微服务设计系列读书笔记的第八篇，主要记录微服务系统的监控。  
微服务：监控小的服务，然后聚合起来看整体。
## 单一服务，单一服务器
监控的内容：
1. CPU、内存等主机数据（Nagios）
2. 服务器本身的日志。

## 单一服务，多个服务器
1. 需要监控有关主机的数据，查看所有主机的数据，还要能查看单个主机自己的数据。  
2. 日志，多个服务器登陆查看日志，比较枯燥。
3. 负载均衡器本身的数据信息。

## 多个服务，多个服务器
从日志到应用程序指标，集中收集和聚合尽可能多的数据到我们手上。
![测试象限](/images/wfwsj08_jk.png)<br/> 

## 日志，更多的日志
1. logstash 可以解析多种日志文件。
2. Kibana 基于ElasticSearch的查看日志的系统。
![测试象限](/images/wfwsj08_elk.png)<br/> 

## 多个服务的指标跟踪
CPU负债增加20%，网站每秒有50条http错误代码，这代表问题吗？ 解决方法：搜集系统指标足够长的时间，直到清晰的模式浮现。   
服务实例数据聚合Graphite，根据数据产生报告或仪表盘。
## 服务指标
linux主机上安装collected并让他们指向Graphite，OS会生成大量指标。 WEB服务最低限度应该暴露响应时间和错误率指标，尽可能的多暴露。

## 关联标识
用户的任何功能都由大量的服务配合提供，一个初始调用会触发多个下游的服务调用。实际想像栈跟踪那样，查看调用链的上游。   
一个方法是使用关联标识（ID）。在触发第一个调用时，生成一个GUID。然后把它传递给所有的后续调用。类似日志级别和日期，可以把关联标识以结构化的方式写入日志。
![关联日志](/images/wfwsj08_glrz.png)<br/> 
![关联日志2](/images/wfw08_glrz2.png)<br/> 

### Zipkin
可以跨多个系统边界跟踪调用，还有一个界面。但是需要自定义客户端并且支持收集系统，稍微重量级。可以利用已经聚合过的日志进行分析。  
若是使用HTTP作为通信协议，只需要包装标准的HTTP客户端库，添加代码确保在HTTP头传递关联标识即可。


## 小结
1. 最低限度要跟踪请求响应时间，后续可以跟踪错误率以及应用程序级别的指标。
2. 最低限度跟踪所有下游服务的健康指标。包括下游调用的响应时间，最好能跟踪错误率。Hystrix。
3. 标准化如何收集指标以及存储指标。
4. 标准格式将日志记录到一个标准的位置。
5. 监控底层OS。





## 参考
[Graphite](http://graphiteapp.org/)






































