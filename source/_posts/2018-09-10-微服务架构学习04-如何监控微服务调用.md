---
title: 微服务架构学习04-如何监控微服务调用
tags: [微服务]
---
# 微服务架构学习04-如何监控微服务调用
本系列文章为极客时间课程《从0开始学微服务》课程记录。与单体应用相比，在微服务架构下，一次用户调用会因为服务化拆分后，变成多个不同的服务之间调用，需要对拆分后的每个服务都进行监控。  
监控主要涉及三个方面：监控对象、监控指标、监控维度。

## 监控对象
主要分成是个层次。
### 用户端监控
业务直接对用户提供的功能进行监控。
### 接口监控
指业务提供的功能所依赖的具体RPC接口的监控。
### 资源监控
比如redis 、 mongodb。
### 基础监控
服务器本身的健康状况进行的监控。CPU、内存、IO、网卡带宽。

## 监控指标
### 请求量。分两个维度，一个是实时请求量，一个是统计请求量。实时请求量用QPS每秒查询次数来衡量。统计请求量用PV即一段时间内用户的访问量来衡量。

### 响应时间
一段时间内所有调用的平均耗时来反映请求的响应时间。但是它只代表了请求的平均快慢的情况，有时候更关心慢请求的数量。为此需要将响应时间划分成多个区间，0-10ms、10ms-50ms、50ms-100ms、100ms-500ms、500ms以上这五个区间。500ms以上代表了慢查询请求量。在正常情况下，最后这个区间查询数量应该为0。   

### 错误率
错误率的监控通常用一段时间内调用失败的次数占调用总次数的比率来衡量，对于接口的错误率一般用接口返回错误码为503的比率来表示。   


## 监控维度
### 全局维度
从整体角度监控对象的请求量、平均耗时以及错误率。
### 分机房维度
为了业务的高可用性，服务通常部署在不止一个机房，不同机房地域不同，同一个监控对象的各种指标相差很大。
### 单机维度
同一个机房内部，不同机器对同一个监控对象各种指标也会有很大的差异。
### 时间维度
同一个监控维度，在每天的同一时刻各种指标也会不同，可能是业务变更导致，可能是运营活动导致。
### 核心维度
区分核心业务和非核心业务。

## 监控系统原理
监控系统包括四个环节：数据采集、数据传输、数据处理和数据展示。
### 数据采集
通常有两种收集方式：
#### 服务主动上报
业务代码中或者服务框架加入数据收集代码，每一次服务调用完成后，主动上报。
#### 代理收集
服务调用后把调用的详细信息记录到本地日志文件中，然后通过代理去解析本地日志文件，然后上报服务调用的信息。
上述两种方式，需要考虑采集数据的频率。在系统比较空闲的时候加大采用率，在系统负债比较高的时候减小采样率。  

### 数据传输
一般采用两种方式。
- UDP传输
- Kafka传输
数据采集后发送到指定的Topic，然后数据处理单元再订阅对应的Topic，就可以从Kafka消息队列中读取到对应的数据。
数据传输一般采用二进制和文本协议，前者传输效率高，后者可读性好。

### 数据处理
通常有两个维度：
#### 接口维度聚合
按接口进行聚合，这样可以得到每个接口的实时请求量、平均耗时等信息。
#### 机器维度聚合
把收集的数据按照调用的节点维度聚合在一起，可以从单机维度查看每个接口的实时请求量、平均耗时等信息。
数据处理后进行数据持久化，一般采用如下两种数据库：
- 索引数据库、Elasticsearch
- 时序数据库、OpenTSDB

### 数据展示
数据展示是把处理后的数据以Dashboard方式展示给用户。
#### 曲线图
展示监控变化趋势。


![微服务监控曲线图](/images/wfwsjwb04_jk1.png)<br/>
#### 饼状图
监控占比分布
![微服务监控饼状图](/images/wfwsjwb04_jk2.png)<br/>

#### 格子图
展示一些细粒度监控，比如不同机器的接口调用数量和耗时情况
![微服务监控格子图](/images/wfwsjwb04_jk3.png)<br/>
## 总结
微服务改造过程中，没有强大的监控能力，在调用失败时，如果不能快速发现系统问题，对于业务来说是一场灾难。







































































































































