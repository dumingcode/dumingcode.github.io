---
title: 微服务架构学习02-微服务的注册和发现
tags: [微服务]
---
# 微服务架构学习02-微服务的注册和发现
本系列文章为极客时间课程《从0开始学微服务》课程记录。
## 服务协议
想要构建微服务，首先要解决的问题是，服务提供者如何发布一个服务，服务消费者如何引用这个服务。具体来说就是服务接口名是什么，调用这个服务传递的参数是什么，接口的返回值是什么？最常见的是：
- RESTful API
- XML配置
- IDL文件
三者之间的优缺点：
![微服务三种服务的优缺点](/images/wbwfw02.png)<br/>

## 服务注册和发现
注册中心：将部署服务的机器地址记录到注册中心，服务消费者在有需求的时候，只需要查询注册中心，输入提供的服务名，就可以得到地址，从而发起调用。  

## 注册中心原理
微服务架构下，主要有三种橘色：服务提供者、服务消费者、服务注册中心，三者相互关系看下图。
![微服务注册中心原理图](/images/wbwfw03.png)<br/>
- RPC Server 提供服务，在启动时，根据服务发布文件中的配置信息，向注册中心注册自身服务，并向注册中心定期发送心跳汇报存活状态。
- RPC Client 调用服务，在启动时，根据服务引用文件中配置的信息，向注册中心订阅服务，把服务注册中心返回的服务节点列表缓存在本地内存中，并与服务提供者建立连接。
- 当RPC Server节点发生变更时，注册中心同步变更，RPC Client感知后会刷新本地内存中缓存的服务节点列表。
- RPC Client从本地缓存的服务节点列表中，基于负载均衡算法选择一台RPC Server发起调用。

## 注册中心实现机制
注册中心需要体用的接口，如何部署，如何存储服务信息，如何监控服务提供者的存活，如果服务提供者节点有变化如何通知服务消费者，以及如何控制注册中心的访问权限。
### 注册中心API
- 服务注册接口，服务提供者通过调用服务注册接口完成服务注册。
- 服务反注册接口，服务提供者调用反注册接口完成服务注销。
- 心跳汇报接口，服务提供者通过心跳汇报接口完成节点存货状态上报。
- 服务订阅接口，服务消费者通过此接口，完成服务订阅，获取可用服务提供者节点列表。
- 服务变更查询接口，服务消费者调用此接口，获取最新可用服务节点列表。
- 后台服务查询接口，方便查询注册中心当前注册了哪些服务信息。
- 服务修改接口，修改注册中心中某一服务的信息。

### 集群部署
注册中心非常重要，一般使用集群部署来保证高可用性，并通过分布式一致性协议来确保不同节点之间的数据保持一致。
### 目录存储
注册中心存储服务信息一般采用层次化的目录结构。
### 服务健康状态检查
zookeeper是通过服务端和客户端的长连接和会话超时控制机制实现服务健康状态检测的。
### 服务状态变更通知
zookeeper通过watcher机制，实现服务状态变更通知给服务消费者。
### 白名单机制
注册中心可以提供一个白名单机制，只有添加到注册中心白名单内的消费者，才能够调用注册中心的注册接口。防止测试环境与生产环境之间错乱。

## 总结
注册中心解耦了生产者和消费者。注册中心还提供了弹性，可以任意伸缩节点。






































































































