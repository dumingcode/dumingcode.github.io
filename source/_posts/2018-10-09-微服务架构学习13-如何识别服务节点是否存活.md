---
title: 微服务架构学习13-如何识别服务节点是否存活
tags: [微服务]
---
# 微服务架构学习13-如何识别服务节点是否存活
## 心跳开关保护机制
在网络频繁抖动的情况下，注册中心可用的节点会不断变化，这时候服务消费者会频繁收到服务提供者节点 变更的信息，于是不断请求注册中心拉取最新的可用服务节点信息。当大量服务消费者，同时请求注册中心获取最新的服务提供者节点信息时，可能会把注册中心带宽占满，尤其是注册中心是百兆网卡情况下。   
针对此种情况，需要一种保护机制，即使在网络频繁抖动的时候，服务消费者也不至于同时去请求注册中心获取最新的服务节点信息。   
一个可行解决方案：给注册中心设置一个开关，当开关打开时，即使网络频繁抖动，注册中心也不会通知所有的服务消费者有服务信息变更，比如只给10%的服务消费者返回变更，这样的话就能将注册中心的请求量减少到10%。   
这个开关仅适合在网络频繁抖动的时候打开，如果网络正常，会导致服务消费者感知最新的服务节点信息延迟。  



## 服务节点摘除保护机制
服务提供者在进程启动时，会注册服务到注册中心，并间隔一段时间，汇报心跳给注册中心，以标识自己的存活状态。如果隔了一段固定时间后，服务提供者仍然没有汇报心跳给注册中心，注册中心会认为该节点未dead，于是该提供者就会被从可用节点信息中移除出去。   

如果遇到网络问题，大批服务提供者节点汇报给注册中心的心跳信息可能会传达失败，注册中心会把他们都从可用节点中移除，造成剩下的可用节点难以承受所有的调用，引起雪崩。但是此种情况下，可能大部分服务提供者节点是可用的，仅仅因为网络原因无法汇报心跳给注册中心就被摘除了。  

上述这种场景，可以设定一个阈值比例，遇到这种情况，注册中心不能摘除超过这个阈值比例的节点。 阈值比例可以根据实际业务的冗余度来确定，通常会把这个比例设定在20%。  


心跳开关保护机制，为了防止服务提供者节点频繁变更导致的服务消费者同时去注册中心获取最新服务节点信息。服务节点摘除保护机制，为了防止服务提供者节点被大量摘除引起服务消费者可以调用的节点不足。可以都是因为注册中心的节点信息是随时可能发生变化的，所以这种注册中心是**动态注册中心**  。

## 静态注册中心
直接在服务消费者端根据调用服务提供者是否成功来判断服务提供者是否可用，如果消费者调用某一个服务提供者节点连续失败超过一定次数，就可以在本地内存中将这个节点标记为不可用。并且每隔一段时间，服务消费者都要向标记为不可用的节点发起保活探测，探测成功后，则将不可用的节点恢复为可用状态，重新发起调用。 这样服务提供者节点就不需要向注册中心汇报心跳信息，注册中心中的服务节点信息也不会冬天变化，称之为**静态注册中心**。  此种情况可以足以应对网络频繁抖动等复杂场景。  


## 总结
针对动态注册中心实际线上业务运行时，如果遇到网络不可靠等因素，提出的解决方案心跳保护机制和服务节点摘除保护机制。  
而静态注册中心的思路，则是基于服务消费者本身调用来判断服务节点是否可用，更加直接和准确。网络出现问题的时候，方案基本不受影响。  











