---
title: 微服务架构学习08-如何将注册中心落地
tags: [微服务]
---
# 微服务架构学习08-如何将注册中心落地
## 注册中心如何存储服务信息
服务信息除了包含节点信息（IP端口）以外，还包含其他的一些信息。比如请求失败时重试的次数，请求结果是否压缩等信息。服务信息常用JSON字符串存储，包含多个字段，每个字段代表不同的含义。  
服务一般会分成多个不同的分组，每个分组的目的不同。
- 核心与非核心。
- 机房，从机房维度来分。
- 线上环境与测试环境。
注册中心的信息结构大致如下：
![微服务服务注册中心](/images/wbwfwsj08_ccjg.png)<br/>

具体存储，一般是按照服务-分组-节点信息三层结构来存储。Service代表服务的具体分组，Cluster代表服务的接口名，节点信息用KV存储。
![微服务服务注册中心存储结构详情](/images/wbwfwsj08_ccjgxq.png)<br/>

## 注册中心工作流程
### 服务提供者注册流程
![微服务服务注册中心注册流程](/images/wbwfwsj08_zcgc.png)<br/>

### 服务提供者反注册流程
![微服务服务注册中心反注册流程](/images/wbwfwsj8_fzclc.png)<br/>
### 服务消费者查询流程
![微服务服务消费者查询流程](/images/wbwfwsj8_xfzcx.png)<br/>

### 服务订阅者订阅变更流程
![微服务服务消费者查询流程](/images/wbwfwsj8_dybg.png)<br/>

## 注册发现遇到的问题
### 多注册中心
消费者能够同时从多个注册中心订阅服务，服务生产者能够同时向多个注册中心注册服务。

### 并行订阅服务
并行订阅，每订阅一个服务就单独用一个线程来处理，这样即使遇到个别服务节点超时，其他服务节点的初始化连接也不受影响。

### 批量反注册服务
偶发的反注册调用会导致不可用的节点残留在注册中心，变成僵尸节点。服务消费者还会把它当做活节点，继续发起调用，导致调用失败。优化反注册逻辑，对于下线机器、节点晓慧场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点提供的所有服务同时反注册掉。
### 服务变更信息增量更新
消费者启动时，除了会查询订阅服务的可用节点做初始化连接，还会订阅服务的变更，每间隔一段时间从注册中心获取最新的服务节点信息标记SIGN，并与本地保存的sign值比对，如果不一样，就会调用注册中心获取最新的服务节点信息。  
如果网络抖动频繁，服务提供者会上报给注册中心的心跳一会失败一会成功，这是注册中心会频繁更新服务的可用节点信息，导致消费者频繁从注册中心更新可用的节点信息，严重时产生网络风暴，导致注册中心带宽被打满。   
采取增量更新方式，注册中心只返回变化的那部分节点信息，这样就可以大量减少消费者从注册中心拉取的数据量。









