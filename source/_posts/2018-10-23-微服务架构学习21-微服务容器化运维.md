---
title: 微服务架构学习21-微服务容器化运维
tags: [微服务]
---
# 微服务架构学习21-微服务容器化运维
服务容器化之前，服务部署在物理机或者虚拟机上，运维通过既有的运维平台来发布服务。应用代码通过Puppet等工具分批发布到这些物理机或者虚拟机上，然后重启服务，完成一次发布流程。  
业务容器化之后，需要一个面向容器的新型运维平台，能够在现有的物理机或者虚拟机上创建容器，并能够对容器的生命周期进行管理，通常叫容器运维平台。    

一个容器运维平台通常包括以下组成部分：镜像仓库、资源调度、容器调度和服务编排。

## 镜像仓库
镜像仓库的概念类似git代码仓库，有一个集中存储的地方，把镜像存储在这里，在服务发布的时候，各个服务器都访问这个集中存储来拉取镜像，然后启动容器。  

docker 官方会提供一个镜像仓库地址：`https://hub.docker.com/`，但是对于业务团队来说，出于安全或者访问速度的需要，会搭建一套私有的镜像仓库。搭建私有镜像仓库的步骤：

### 权限控制
镜像仓库设有两层权限控制：一是必须登录才可以访问，最外层控制。二是对镜像按照项目的方式进行划分，，每个项目拥有自己的镜像仓库目录，并且给每个项目设置项目管理员、开发者以及客人这三个角色。 


### 镜像同步
实际生产环境，镜像需要同时发布到几十台或者上百台集群节点上，单个镜像仓库实例往往受带宽原因限制无法同时满足大量节点的下载需求，这时候需要配置多个镜像仓库实例来做负载均衡，这就产生了镜像在多个镜像仓库之间同步的问题。   

一般有两种方案，一种是一主多从，主从复制的方案。比如开源镜像仓库Harbor，另一种是P2P方案，比如阿里的容器镜像分发系统蜻蜓。下面介绍Harbor方案。   
Harbor采取主从复制方案，把镜像传到一个主镜像仓库实例上去，然后其他从镜像仓库实例都从主镜像仓库实例同步。  

![docker](/images/wbwfwsj21_docker01.png)<br/>



### 高可用性
一般是把服务部署在多个IDC。两个IDC的镜像同步采用Harbor的双主复制策略，互相复制镜像。这样即使一个IDC出现问题，另一个IDC仍然能够提供服务。  

![docker](/images/wbwfwsj21_docker02.png)<br/>

## 资源调度
资源调度解决的是，Docker镜像要分发到哪些机器上去，这些机器从哪里来。服务部署的集群主要包括三种：
（1）物理机集群（2）虚拟机集群（3）公有云集群。为了解决资源调度的问题，Docker官方提供了Docker Machine功能，通过它可以在企业内部物理机集群、虚拟机集群或者公有云集群上直接部署容器。   

资源调度的最大难点在于如何连接各个不同的集群，统一管理来自不同集群的机器权限管理、成本核算以及环境初始化等操作，这时候需要有一个统一的层来完成这个操作。微博专门开发了 DCP 容器运维平台。

## 总结
镜像仓库解决的是Docker镜像如何存储或者访问的问题，在业务规模较大时，个股业务团队都需要搭建自己的私有镜像仓库。类似Harbor这种开源解决方案能够很好地解决权限控制、镜像同步等操作。

资源调度帮我们解决的是如何整合来自不同的集群的资源的问题，如果业务不止在内部私有云上部署、在公有云上也有部署，那么资源调度会是复杂问题。




























































 





























































