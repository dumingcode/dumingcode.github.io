---
title: 微服务架构学习17-服务调用失败时的处理手段
tags: [微服务]
---
# 微服务架构学习17-服务调用失败时的处理手段
单体应用改造成微服务后，需要针对服务调用失败进行特殊处理，服务调用失败时的处理手段如下：

## 超时
单体应用被改造成微服务架构后，一次用户调用会被拆分成多个系统之间的服务调用，任何一次服务调用如果发生问题都会导致最后用户调用失败。在微服务架构下，一个系统的问题会影响所有调用这个系统所提供服务的服务消费者，容易造成整个系统的雪崩。  
在实际项目中，针对服务调用都要设置一个超时时间，以避免依赖的服务迟迟没有调用结果，而把服务消费者拖死。超时时间采取P999或者P9999，就是以99.9%或者99.99%的调用都在多少毫秒内返回为准。    

## 重试
有时候会因为网络的偶发原因导致超时，如果换个节点可能会访问成功。概率上一次服务调用失败概率是1%，连续两次失败概率就是0.01%，失败率降为原来的1%。  
在实际服务调用时，需要设置一个服务调用超时后的重试次数。

## 双发
每次服务消费者发起服务调用时，都同时发起两次服务调用，一方面可以提高调用的成功率，另一方面两次服务调用哪个先返回就用哪个，平均响应时间也要比一次调用要快，这就是双发。    

但是这样会给后端服务两倍的压力，所以一般情况下不采用这种双发。考虑采用一个更为聪明的双发，即“备份请求”，大致思想是服务消费者发起一次服务调用时，在给定的时间内没有返回结果，就立刻发起另一次服务调用。需要特别注意的是，这个时间设置的要比超时时间短的多。   
备份请求需要设置一个重试比例，避免在服务端出现问题时，大部分请求响应都会超过P90的值，导致请求量翻倍，给服务提供者造成更大的压力，一般情况下重试比例建议设置为15%。    


## 熔断
上述的各种处理方案对于偶发故障比较有用，如果是服务提供者出现故障，短时间内无法恢复，这时候建议使用熔断方案。   

![熔断](/images/wbwfwsj17_rd.png)<br/>

- Closed 状态：正常情况下，断路器处于关闭状态，偶发的调用失败也不影响。
- Open 状态：服务调用失败次数达到一定阈值时，断路器就会处于开启状态，后续服务调用直接返回，不会向服务提供者发起请求。
- Half Open 状态：断路器开启后，每隔一段时间，会进入半打开状态，这时候会向服务提供者发起探测调用，以确定服务提供者是否恢复正常。如果调用成功，断路器就会关闭，如果没有成功，断路器就会保持开启状态，并等待下一个周期重新进入半打开状态。  

## Hystrix
最经典使用也最广泛的莫过于Netflix的Hystrix。Hystrix的断路器包含关闭、打开、半打开三种状态。Hystrix会把每一次服务调用都用`HistrixCommand`封装起来，会实时记录每一次服务调用的状态，包括成功、失败、超时还是被线程拒绝。  
Hystrix的工作过程：    
当一段时间内服务调用的失败率高于设定的阈值后，Hystrix断路器会进入打开状态，新的服务调用会直接返回，不会向服务提供者发起调用。再等待设定的时间间隔后，Hystrix的断路器又会进入半打开状态，新的服务调用又可以重新发给服务提供者，如果一段时间内服务调用的失败率依然高于设定的阈值后，断路器会重新进入打开状态。否则的话，断路器会被重置为关闭状态。    
Hystrix的工作原理采用滑动窗口机制实现。  


## 总结
请求调用如果是非幂等的不能使用重试，例如绝大多数上行请求。至于双发，服务调用的P999能大幅减少，实践证明是提高服务调用成功率的有效手段。熔断能够很好解决服务故障引起的连锁反应。

[Hystrix使用](https://github.com/Netflix/Hystrix/wiki/How-To-Use)















 





























































