---
title: 微服务架构学习25-微服务容量规划
tags: [微服务]
---
# 微服务架构学习25-微服务容量规划
在单体应用时，只需要针对这个单体应用的访问量和实际接口性能来决定要不要给单体应用扩容，拆分为众多的微服务之后，需要考虑每个服务的容量规划，复杂度主要来自下面几个方面：
- 服务数量众多，人肉运维难以管理，微博FEED业务仅仅RPC服务就有将近40个。
- 服务接口表现差异巨大，有轻接口（访问量大但响应时间快）和重接口之分。
- 服务部署的集群规模大小不同，需要扩容的机器数量差异很大。Feed服务上千台机器。
- 服务之间还存在依赖关系，在服务扩容的时候，还需要考虑依赖服务的容量是否足够。

## 容量规划系统
容量规划系统的作用是根据各个微服务部署集群的最大容量和线上实际运行的负荷，来决定各个微服务是否需要弹性扩缩容，以及需要扩缩容多少台机器。   

### 容量评估
一般集群的容量评估都是通过线上实际压测来确定的，线上压测的关键点如下：
#### 选择合适的压测指标
- 一类是系统类指标，比如机器的CPU使用率、内存占用量、磁盘IO使用率以及网卡带宽。
- 一类是服务类指标，比如接口响应的平均耗时，P999耗时、错误率。（平均耗时不是个好的观察量，平均耗时正常的情况下，可能出现慢请求）     
- 接口的慢速比，也就是接口响应时间高于某个阈值的比例。比如微博Feed接口压测时，选择的压测指标是Feed接口响应时间大于1S的比例，压测的终止条件是Feed接口响应时间大于1S的比例超过1%。    
对于大多数在线服务，接口慢速比不超过1%是服务质量保证的底线，可以作为一个通用的压测指标。  


#### 压测获取单机的最大容量
集群的最大容量就是单机的最大容量*集群的机器数量。获得集群的最大容量，就必须获得单机的最大容量。通常有两种方式获取单机的最大容量，一种是单机压测，一种是集群压测。   
- 单机压测两种方式，一种是通过日志回放手段，模拟线上流量对单机进行压测。 一种是通过TCP-Copy的方式，把线上的流量拷贝过来对单机进行压测。
- 集群压测是对整个集群进行压测，以获取单机的最大容量。一般做法是通过不断把线上集群的节点摘除，以减少机器数的方式，来增加线上节点单机的流量。

采用集群压测方式更合理一些，因为它完全使用线上真实流量进行压测，获取单机的最大容量数值更精确。不过使用集群压测，压测时候可能会对线上用户的实际需求产生影响。

采用集群压测，不断缩减线上节点数量，并观察服务的慢速比指标，当慢速比达到1%时，就停止压测，这个时候就可以计算单机的最大容量了，一般做法是用压测停止时的单机平均QPS作为单机的最大容量。    

![QPS](/images/wbwfwsj25_qps.png)<br/>

由上图可知，在单机QPS都是100的情况下，左边单机还能继续加大QPS，右边的单机已经出现超过500ms以上的慢请求了。  
一个合理的计算单机容量的方式是采用区间加权来计算，响应时间越长权重越高。比如0-10ms区间权重1，10-50ms权重2，50-100ms权重4,500ms以上权重32。  
 
 
#### 实时获取集群的运行负荷
统计每台单机在不同耗时区间内的请求数，推送到集中处理的地方进行聚合，将同一个集群内的单机位于不同耗时区间内的请求数进行汇总，就得到整个集群的请求在不同耗时区间的分布了，再利用区间加权的方式就可以计算出整个集群的运行负荷。 

![水位线](/images/wbwfwsj25_swx.png)<br/>

如上图水位线所示，当水位线位于致命线下时，就需要立即扩容。在扩容一定数量的机器后，水位线回到安全线以上并保持一段时间后，就可以进行缩容了。  
在进行扩缩容时，机器的数量决定：   

#### 扩容
在决定扩多少机器时，一般有两种方式，一种按数量，一种按比例。因为不同集群内的机器数量差别很大，所以一般采取按比例的方式，比如一次性都增加30%的机器数量。  

#### 缩容
在扩容完成后，集群的水位线保持在安全线以上一段时间以后，需要进行缩容。可以根据实际业务特点来决定多久可以缩容，比如微博的业务一般突发流量在1小时以内，因此集群的水位线在安全线上超过1个小时后，就可以缩容。缩容的时候，不是一次把所有扩容的机器都缩掉，而是采用逐步缩容的方式。比如，每5分钟判断一次集群的水位线是否还在致命线上，然后按照10%、30%、50%、100%的比例进行缩容。   

在实际根据水位线进行扩缩容时，还需要防止网络抖动等原因造成的水位线瞬间抖动，这个时候集群运行负荷会突然变大，导致水位线异常。为了防止瞬间抖动，可以每分钟采集一次系统的水位线，一共采集5个点，只有5个点有3个点满足扩容条件，才真正扩容。  

## 总结
- 容量评估，通过压测获取集群的最大容量，并实时采集服务调用的数据以获取集群的实时运行负荷，这样就可以获取集群的实时水位线。   
- 调度决策，通过水位线与致命线和安全线对比来决定什么时候扩缩容。扩容的机器数一般按照集群的机器数量的比例来决定。缩容一般采取逐步缩容的方式以避免缩容太快。






















































 





























































