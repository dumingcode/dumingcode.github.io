---
title: 微服务架构学习26-多机房部署实践
tags: [微服务]
---
# 微服务架构学习26-多机房部署实践
多机房部署微服务的关键问题：
- 一切正常时用户请求访问哪个机房
- 多个机房之间数据如何同步
- 多个机房之间的数据如何确保一致性

## 多机房负载均衡
根据用户访问的IP，通过DNS解析到不同的机房，北方用户访问联通机房，南方用户访问电信机房。为了实现负载均衡，会在每个机房分别部署四层负载均衡器VIP以及七层负载均衡器Nginx。    
比如来自北方用户的请求通过DNS解析到联通机房下任意一个VIP，然后通过VIP把请求转发给联通机房下任意一个Nginx，Nginx再把请求转发给联通机房下任意一个Tomcat容器。

![负载均衡器](/images/wbwfwsj26_fzjh.png)<br/>

但是在实际部署时，并不能完全遵循就近访问的原则，需要根据需要调配流量，示意图如下：   
![负载均衡器2](/images/wbwfwsj26_fzjh2.png)<br/>

## 多机房数据同步
实现服务部署到多机房供用户访问的前提是：每个机房的数据是一样的。这就要求多个机房之间的数据必须保持同步，一般对于高并发访问的服务来说，数据通常会有两层存储缓存层和数据库层。   
![数据同步](/images/wbwfwsj2_store.png)<br/>
数据一致既要保证数据库层的数据一致又要保证缓存层的数据一致。  

### 主从机房架构
主从机房架构以一个机房为主机房，所有的写请求都只发给主机房的处理机，由主机房的处理机来更新本机房的缓存和数据库。其他机房的缓存也通过主机房的处理机来更新，而数据库则通过MySQL的binlog同步机制来实现数据同步。采用这样的架构，风险点在主机房。
![主从机房架构](/images/wbwfwsj26_sjtb.png)<br/>

### 独立机房架构
同步方案见下图，联通电信机房都有写请求，并通过一个叫作WMB的消息同步组件把各自机房的写请求同步一份给对方机房。每个机房的处理机接收到写请求后更新各自机房的缓存，但是只会有一个机房更新数据库，其他机房的数据库通过MySql的binlog同步机制实现数据同步。  
![独立机房架构](/images/wbwfsj26_dljf.png)<br/>

独立机房的核实在于WMB消息同步组件，实现原理图如下：
![独立机房架构](/images/wbwfwsj26_wmb.png)<br/>
WMB分成两个部分：
- reship，负责把本机房的写请求分发一份给别的机房。
- collector，负责从别的机房读取写请求，然后再把请求转发给本机房的处理机。  
WMB 如何实现消息同步功能，方案有两种，一种是通过MCQ消息队列，一种是通过RPC调用。
- MCQ 消息队列实现
![MCQ](/images/wbwfwsj26_mcq.png)<br/>

- RPC调用实现
![RPC](/images/wbwfwsj26_rpc.png)<br/>


## 多机房数据一致性
多机房数据同步过程中，会因为各种原因导致各机房之间数据不一致。微博的服务主要通过消息对账机制来保证最终一致性。

消息对账机制见下面。在整个环节中，requestID会一直保持向下传递，无论处理成功或者失败都会记录一条包含requestId和机房标记的处理日志，并写到Elasticsearch集群上去。然后通过一个定时线程，每间隔1分钟扫描Elasticsearch集群上的日志，找到包含同一个requestID的不同机房的处理日志，然后验证是否在各个机房都请求处理成功，如果有失败，则可以根据日志信息重试该阶段直成功（重试前提是满足服务的幂等），从而保证数据的最终一致性。   

数据库与缓存先后顺序：一般是先写数据库，再写缓存。



![数据一致性](/images/wbwfwsj26_yzx.png)<br/>

## 总结
主要讲解了微服务多机房部署时要面临的三个问题，一是如何保证负债均衡，二是多机房之间数据如何保证同步，三是多机房之间数据如何保证一致性。














 





























































