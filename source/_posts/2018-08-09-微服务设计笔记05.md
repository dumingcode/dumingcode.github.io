---
title: 微服务设计笔记05
tags: [微服务]
---
# 微服务设计笔记05
本篇笔记为微服务设计系列读书笔记的第五篇，主要记录分解单块系统。   
## 关键是接缝
从接缝处可以抽取出相对独立的一部分代码，对这部分代码的修改不会影响系统的其他部分。限界上下文就是一个非常好的接缝。某单块系统的实例：
1. 产品目录
2. 财务
3. 仓库
4. 推荐
## 分解单块系统的原因
增量方式分解单块系统比较合适。指导因素：
1. 改变的速度。接缝抽出来某个功能，成为一个单独的服务，后期开发速度大大加快。
2. 团队结构。不同团队维护的代码分离出来。
3. 安全。特定服务进行监控，传输数据的保护和静态数据的保护。
4. 技术。
5. 杂乱的依赖。单独拉取出来的接缝应该尽量少地被其他组件所依赖。若几个接缝之间可以形成一个有向无环图，就能够识别哪些接缝比较难处理。
6. 数据库是所有依赖的源头。

## 打破外键关系
![微服务打破主外键01](/images/wfw05_zwj01.png)<br/>
上图中两个微服务之间共享了数据表。
![微服务打破主外键02](/images/wfw05_zwj02.png)<br/>
上图财务模块通过访问产品模块API的方式，避免了直接数据访问的缺陷。   
主外键关系需要由数据库层面实现，变为代码中实现。

## 数据共享
1. 共享静态数据，比如国家代码，可以放入配置文件或者代码中。
2. 共享可变数据。多个微服务向同一个表写入数据。比如财务服务和仓库服务都会向客户表中写入数据，于是这里缺失的领域概念是客户。需要将抽象的客户概念具象化，形成一个清晰的客户服务。

## 数据库重构
想要在一次发布中把单块服务直接变成两个服务，并且每个服务有各自的数据库结构，事实上会推荐先分离数据库结构。
![微服务数据库重构](/images/wfw05_sjcg.png)<br/>

## 事务边界
下单后更新订单表的同时，也应该调用仓库服务通知派发订单。跨事务边界的操作，见下图。
![跨事务边界](/images/wfw05_kswbj.png)<br/>
### 最终一致性
知道订单被捕获处理就足够了，后面再对仓库的提取表做一次插入操作。可以把这部分操作放在一个队列，之后再进行触发。
### 终止整个操作
利用补偿事务去抵消之前的操作，但是需要考虑补偿事务失败的情况。比如采用后台定时任务清除，提供界面供维护人员处理等。
### 分布式事务
使用一个叫作事务管理器的工具来统一编配其他底层系统中运行的事务。分布式事务常用算法：两阶段提交。    

投票阶段，每个参与者会告诉事务管理器它是否应该继续，如果事务管理器收到的所有投票都是成功，则会告知他们进行提交操作。收到一个否定的投票，事务管理器就会让所有的参与者回退。  
上述过程中，会假定认为事务管理器不会发生故障，消息发送也肯定能成功。   

综上最终一致性较为容易，分布式事务实现复杂性较大。
## 报表数据
### 服务调用获取数据
展示过去15分钟内下的订单数量，这种通过API调用实现。但是访问大数据量的数据，这种方法就失效了。
### ODS数据导出
把各个微服务的数据，统一推送到一个统一的数据库中。这种是前面数据库集成的特例。

## 参考
《微服务设计》







