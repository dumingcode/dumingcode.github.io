---
title: 微服务限流
tags: [微服务]
---
# 微服务限流
## 常用限流架构
1. 在接入层(api-gateway)集成限流功能。分布式或者单实例，如果多实例部署需要考虑使用分布式限流算法。
2. 限流功能封装成RPC服务。
微服务接收到请求后，会通过限流服务暴露的RPC接口查询请求是否超过阈值。需要单独部署限流服务，增长运维成本。限流服务本身可能会成为系统性能的瓶颈。
3. 限流功能集成在微服务系统内。需要集成在切面层，尽量与业务代码解耦。
## 限流算法
1. 固定、滑动时间窗口限流。适合微服务接口。
2. 令牌桶、漏桶限流算法。适合阻塞限流。后台一些JOB类限流，超过最大访问频率后，请求不会被拒绝，而是阻塞 到有令牌后再继续执行。


## 限流熔断策略
1. 记录日志
2. 发送告警
3. 服务降级  
上线初期适合采用日志记录和告警，待通过日志分析限流达到效果后，再进一步升级为其他限流熔断策略。

## 验证是否有效
针对每次请求需要记录下，对应接口、请求时间点、限流结果（通过还是熔断），通过记录数据绘制图表。

## 限流开发库-Ratelimiter4j
限流开发库需要具有以下特点：
1. 低延迟，不能或者较小影响接口本身的响应时间。
2. 高度容错，限流框架异常不能影响微服务的可用性。
3. 高TPS。限流框架的TPS至少要大于微服务本身的接口TPS。

## 参考
[微服务接口限流的设计与思考（附GitHub框架源码）](https://mp.weixin.qq.com/s?__biz=MzIwMzg1ODcwMw==&mid=2247488188&idx=1&sn=9e77a94b271909fecba136baab66a722&chksm=96c9a4dca1be2dcae2b1780cefaf22a6b6db4ecbe46357cf9e66dd3635db31bd3fea29414c36#rd)
[Ratelimiter4j](https://github.com/wangzheng0822/ratelimiter4j)