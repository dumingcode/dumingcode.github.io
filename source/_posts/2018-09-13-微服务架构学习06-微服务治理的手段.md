---
title: 微服务架构学习06-微服务治理的手段
tags: [微服务]
---
# 微服务架构学习06-微服务治理的手段
本系列文章为极客时间课程《从0开始学微服务》课程记录。  
微服务改造之后，一次服务调用，服务提供者、注册中心、网络三者可能都会存在问题，此时消费者如何确保调用能够成功呢？这就是服务治理所要解决的问题。  

## 节点管理
### 注册中心主动摘除机制
服务提供者定时向注册中心汇报心跳，注册中心根据服务提供者最近一次的汇报心跳与上一次汇报心跳时间做出比较，如果超出一定时间，就认为服务提供者出现问题。然后把节点从服务列表中摘除，并把最近可用服务节点列表推送给服务消费者。

### 服务消费者摘除机制
如果消费者调用生产者节点失败，就把这个节点从内存中保存的可用服务提供者节点列表中移除。理解是hystrix。

## 负载均衡
服务生产者的机器配置可能不同，尽量让配置好的多承担访问量。常用负载均衡算法：
### 随机算法
调用量比较均匀。
### 轮询算法
按照固定权重，对可用服务节点进行轮询。
### 最少活跃调用算法
选择连接数最小的节点发起调用，也就是选择调用量最小的服务节点，性能理论上是最优的。
### 一致性hash
相同参数的请求总是发送到同一服务节点，当一个节点出现故障时，原本发往该节点的请求，基于虚拟节点机制，平衡到其他节点。  


## 服务路由
对于消费者而言，内存中的服务节点列表选择哪个节点不仅由负载均衡算法起作用，还由路由规则起作用。路由规则：通过一定的规则如条件表达式或者正则表达式来限定服务节点的选择范围。
### 路由规则存在的原因
- 业务存在灰度发布的需求，根据用户尾号
- 多机房就近访问，根据ip制定路由规则

### 路由规则配置方式
- 静态配置。服务消费者本地存放服务调用的路由规则。
- 动态规则。路由规则存放在注册中心，消费者定期去请求注册中心同步。


## 服务容错
服务容错的常用手段：
### FailOver 失败自动切换
服务消费者发现调用失败或者超时后，自动从可用的服务节点列表中选择下一个节点重新发起调用，也可以设置重试次数。要求服务调用幂等，不管调用多少次，只要是同一个调用，返回结果必须相等，适合读请求。

### FailBack 失败通知
消费者调用失败后，不再重试。而是根据失败的详细信息，决定后续的执行策略。对于非幂等的调用场景，不能重试，而是应该查询服务端状态，看调用到底是否实际生效。

### FailCache 失败缓存
服务消费者调用失败或者超时后，不立即重试，而是间隔一段时间再次尝试发起调用。

### FailFast 快速失败
消费者调用一次失败后，不再重试。一般非核心业务调用，采用快速失败，记录日志后就返回。

一般幂等的使用FailOver或者FailCache，不是幂等调用选择FailBack或者FailFast。

## 常用开源
服务治理手段一般都会在服务框架中默认集成了，比如阿里的Dubbo，微博开源的服务框架Motan，不需要业务代码实现。

























