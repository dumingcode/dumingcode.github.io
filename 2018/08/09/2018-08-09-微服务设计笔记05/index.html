<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录技术学习以及读书心得"><meta name="keywords" content="study"><title>微服务设计笔记05 | 学习之路</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">微服务设计笔记05</h1><a id="logo" href="/.">学习之路</a><p class="description">做只笨鸟</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">微服务设计笔记05</h1><div class="post-meta"><a href="/2018/08/09/2018-08-09-微服务设计笔记05/#comments" class="comment-count"></a><p><span class="date">Aug 09, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="微服务设计笔记05"><a href="#微服务设计笔记05" class="headerlink" title="微服务设计笔记05"></a>微服务设计笔记05</h1><p>本篇笔记为微服务设计系列读书笔记的第五篇，主要记录分解单块系统。   </p>
<h2 id="关键是接缝"><a href="#关键是接缝" class="headerlink" title="关键是接缝"></a>关键是接缝</h2><p>从接缝处可以抽取出相对独立的一部分代码，对这部分代码的修改不会影响系统的其他部分。限界上下文就是一个非常好的接缝。某单块系统的实例：</p>
<ol>
<li>产品目录</li>
<li>财务</li>
<li>仓库</li>
<li>推荐<h2 id="分解单块系统的原因"><a href="#分解单块系统的原因" class="headerlink" title="分解单块系统的原因"></a>分解单块系统的原因</h2>增量方式分解单块系统比较合适。指导因素：</li>
<li>改变的速度。接缝抽出来某个功能，成为一个单独的服务，后期开发速度大大加快。</li>
<li>团队结构。不同团队维护的代码分离出来。</li>
<li>安全。特定服务进行监控，传输数据的保护和静态数据的保护。</li>
<li>技术。</li>
<li>杂乱的依赖。单独拉取出来的接缝应该尽量少地被其他组件所依赖。若几个接缝之间可以形成一个有向无环图，就能够识别哪些接缝比较难处理。</li>
<li>数据库是所有依赖的源头。</li>
</ol>
<h2 id="打破外键关系"><a href="#打破外键关系" class="headerlink" title="打破外键关系"></a>打破外键关系</h2><p><img src="/images/wfw05_zwj01.png" alt="微服务打破主外键01"><br><br>上图中两个微服务之间共享了数据表。<br><img src="/images/wfw05_zwj02.png" alt="微服务打破主外键02"><br><br>上图财务模块通过访问产品模块API的方式，避免了直接数据访问的缺陷。<br>主外键关系需要由数据库层面实现，变为代码中实现。</p>
<h2 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h2><ol>
<li>共享静态数据，比如国家代码，可以放入配置文件或者代码中。</li>
<li>共享可变数据。多个微服务向同一个表写入数据。比如财务服务和仓库服务都会向客户表中写入数据，于是这里缺失的领域概念是客户。需要将抽象的客户概念具象化，形成一个清晰的客户服务。</li>
</ol>
<h2 id="数据库重构"><a href="#数据库重构" class="headerlink" title="数据库重构"></a>数据库重构</h2><p>想要在一次发布中把单块服务直接变成两个服务，并且每个服务有各自的数据库结构，事实上会推荐先分离数据库结构。<br><img src="/images/wfw05_sjcg.png" alt="微服务数据库重构"><br></p>
<h2 id="事务边界"><a href="#事务边界" class="headerlink" title="事务边界"></a>事务边界</h2><p>下单后更新订单表的同时，也应该调用仓库服务通知派发订单。跨事务边界的操作，见下图。<br><img src="/images/wfw05_kswbj.png" alt="跨事务边界"><br></p>
<h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><p>知道订单被捕获处理就足够了，后面再对仓库的提取表做一次插入操作。可以把这部分操作放在一个队列，之后再进行触发。</p>
<h3 id="终止整个操作"><a href="#终止整个操作" class="headerlink" title="终止整个操作"></a>终止整个操作</h3><p>利用补偿事务去抵消之前的操作，但是需要考虑补偿事务失败的情况。比如采用后台定时任务清除，提供界面供维护人员处理等。</p>
<h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><p>使用一个叫作事务管理器的工具来统一编配其他底层系统中运行的事务。分布式事务常用算法：两阶段提交。    </p>
<p>投票阶段，每个参与者会告诉事务管理器它是否应该继续，如果事务管理器收到的所有投票都是成功，则会告知他们进行提交操作。收到一个否定的投票，事务管理器就会让所有的参与者回退。<br>上述过程中，会假定认为事务管理器不会发生故障，消息发送也肯定能成功。   </p>
<p>综上最终一致性较为容易，分布式事务实现复杂性较大。</p>
<h2 id="报表数据"><a href="#报表数据" class="headerlink" title="报表数据"></a>报表数据</h2><h3 id="服务调用获取数据"><a href="#服务调用获取数据" class="headerlink" title="服务调用获取数据"></a>服务调用获取数据</h3><p>展示过去15分钟内下的订单数量，这种通过API调用实现。但是访问大数据量的数据，这种方法就失效了。</p>
<h3 id="ODS数据导出"><a href="#ODS数据导出" class="headerlink" title="ODS数据导出"></a>ODS数据导出</h3><p>把各个微服务的数据，统一推送到一个统一的数据库中。这种是前面数据库集成的特例。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《微服务设计》</p>
</div><div class="tags"><a href="/tags/微服务/">微服务</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/08/13/2018-08-13-穷查理宝典语句摘抄/" class="pre">穷查理宝典语句摘抄</a><a href="/2018/08/08/2018-08-08-微服务设计笔记04/" class="next">微服务设计笔记04</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTcyNC8xMjI2MA"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务设计笔记05"><span class="toc-text">微服务设计笔记05</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#关键是接缝"><span class="toc-text">关键是接缝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分解单块系统的原因"><span class="toc-text">分解单块系统的原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#打破外键关系"><span class="toc-text">打破外键关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据共享"><span class="toc-text">数据共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库重构"><span class="toc-text">数据库重构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务边界"><span class="toc-text">事务边界</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#最终一致性"><span class="toc-text">最终一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#终止整个操作"><span class="toc-text">终止整个操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式事务"><span class="toc-text">分布式事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#报表数据"><span class="toc-text">报表数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务调用获取数据"><span class="toc-text">服务调用获取数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ODS数据导出"><span class="toc-text">ODS数据导出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/2018-08-20-微服务设计笔记08/">微服务设计笔记08</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/2018-08-19-微服务实践04-熔断监控Hystrix Dashboard和Turbine/">微服务实践04-熔断监控Hystrix Dashboard和Turbine</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/2018-08-18-微服务实践03-熔断器Hystrix/">微服务实践03-熔断器histrix</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/2018-08-18-微服务实践02-eureka服务提供者和消费者/">微服务实践02-eureka服务提供者和消费者</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/2018-08-18-微服务实践01-服务中心eureka/">微服务实践01-服务中心eureka</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/17/2018-08-17-微服务设计笔记07/">微服务设计笔记07</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/14/2018-08-14-微服务设计笔记06/">微服务设计笔记06</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/13/2018-08-13-穷查理宝典语句摘抄/">穷查理宝典语句摘抄</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/2018-08-09-微服务设计笔记05/">微服务设计笔记05</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/2018-08-08-微服务设计笔记04/">微服务设计笔记04</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/运动/" style="font-size: 15px;">运动</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/规划/" style="font-size: 15px;">规划</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/CICD/" style="font-size: 15px;">CICD</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://github.com/dumingcode" title="github" target="_blank">github</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">DuMing.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>